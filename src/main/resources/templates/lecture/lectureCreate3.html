<!--resources/templates/lecture/lectureCreate3-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>강좌개설3단계</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script> <!-- 여기에 추가 -->
</head>
<body>

<div class="container">
    <h2>강좌 개설 3단계 - 확인 및 완료</h2>

    <div id="lectureReview" class="mb-4"></div>

    <div class="buttons">
        <button type="button" class="btn btn-secondary" onclick="goBackToStep2()">이전단계로</button>

        <button type="button" class="btn btn-primary" onclick="completeCreation()">강좌 개설하기</button>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
    var userIdElement = document.getElementById('userId');

    $(document).ready(function() {
        const userId = localStorage.getItem('userId');
        const step1Data = JSON.parse(localStorage.getItem('step1Data'));

        if (!step1Data) {
            alert('강좌 개설 정보가 올바르지 않습니다. 처음부터 다시 시작해주세요.');
            window.location.href = '/lecture/lectureCreate';
            return;
        }

        // 이전 단계 데이터를 화면에 표시
        displayReview(step1Data);
    });

    function displayReview(step1Data) {
        const reviewDiv = $('#lectureReview');

        const userId = localStorage.getItem('userId');

        const category = `<div class="mb-2"><strong>카테고리:</strong> ${step1Data.category}</div>`;
        const title = `<div class="mb-2"><strong>강좌 제목:</strong> ${step1Data.title}</div>`;
        const content = `<div class="mb-2"><strong>강좌 소개:</strong> ${step1Data.content}</div>`;
        const learningTarget = `<div class="mb-2"><strong>학습 대상:</strong> ${step1Data.learningTarget}</div>`;
        const week = `<div class="mb-2"><strong>주:</strong> ${step1Data.week}</div>`;
        // ... 다른 필드들도 이런 식으로 추가 ...

        reviewDiv.append(category);
        reviewDiv.append(title);
        reviewDiv.append(content);
        reviewDiv.append(learningTarget);
        reviewDiv.append(week);
        // ... 다른 필드들도 이런 식으로 추가 ...
    }

    async function completeCreation() {
        const step1Data = JSON.parse(localStorage.getItem('step1Data'));

        if (!step1Data) {
            alert('데이터가 올바르지 않습니다. 확인 후 다시 시도해주세요.');
            return;
        }

        // 파일을 서버에 업로드하고, 업로드된 URL을 받아와 step1Data에 추가합니다.
        const fileInput = document.getElementById('ImageUrl');
        const file = fileInput.files[0];

        if (file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await axios.post('/api/upload', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });

                step1Data.fileUrl = response.data.url;  // 파일 URL을 step1Data에 추가
            } catch (error) {
                console.error('Error uploading file:', error);
                alert('파일 업로드 중 오류가 발생했습니다. 다시 시도해주세요.');
                return;
            }
        }

        // 강좌 정보를 서버에 전송합니다.
        try {
            const response = await axios.post('/api/lectures', step1Data);
            console.log('Lecture created:', response.data);

            alert('강좌가 성공적으로 생성되었습니다.');
            window.location.href = '/lectures';  // 강좌 목록 페이지로 리디렉션
        } catch (error) {
            console.error('Error creating lecture:', error);
            alert('강좌 생성 중 오류가 발생했습니다. 다시 시도해주세요.');
        }
    }
</script>

</body>
</html>
